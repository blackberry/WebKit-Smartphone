#!/usr/bin/perl -w

# Copyright (C) 2006, 2007, 2008, 2009 Apple Inc.  All rights reserved.
# Copyright (C) 2009 Torch Mobile Inc. All rights reserved.
# Copyright (C) Research in Motion Inc. 2010 All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#
# 1.  Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
# 2.  Redistributions in binary form must reproduce the above copyright
#     notice, this list of conditions and the following disclaimer in the
#     documentation and/or other materials provided with the distribution.
# 3.  Neither the name of Apple Computer, Inc. ("Apple") nor the names of
#     its contributors may be used to endorse or promote products derived
#     from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND ANY
# EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
# DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
# ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
# THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

# Script to generate build information file

use strict;
use File::Basename;
use File::Spec;
use FindBin;
use lib $FindBin::Bin;
use Term::ReadKey;
use VCSUtils;
use webkitdirs;

sub usage
{
    print "Usage: [--help] <file>\n";
    exit 1;
}

my $help = checkForArgumentAndRemoveFromARGV("--help");
if ($help) {
    usage();
}

my $infofile = $ARGV[0];
if (!$infofile) {
    usage();
}

open INFOFILE, ">$infofile" or die;
print INFOFILE <<ENDHEADER;
/*
 * THIS FILE IS AUTOMATICALLY GENERATED, DO NOT EDIT.
 *
 *
 * Copyright (C) Research in Motion Inc. 2010 All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY RESEARCH IN MOTION INC. ``AS IS'' AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE COMPUTER, INC. OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

#include "AboutData.h"

namespace WebCore {

#if PUBLIC_BUILD
const char BUILDINFO[]="";
#else
const char BUILDINFO[]=
"<html><head><title>BlackBerry Browser Build Information</title></head><body><h1>BlackBerry Browser Build Information</h1><table>"
ENDHEADER

print INFOFILE "\"<tr><td>Build User</td><td>" . $ENV{'USERNAME'} . "</td></tr>\"\n";

my $date = `date`;
chomp($date);
print INFOFILE "\"<tr><td>Build Time</td><td>$date</td></tr>\"\n";
print INFOFILE "\"<tr><td>Build Computer</td><td>" . $ENV{'COMPUTERNAME'} . "</td></tr>\"\n";
print INFOFILE "\"<tr><td>Build Platform</td><td>" . $ENV{'PLATFORMNAME'} . "</td></tr>\"\n";
print INFOFILE "\"<tr><td></td><td></td></tr>\"\n";

chdir($ENV{WEBKITDIR});

if (isGit()) {
    print INFOFILE "\"<tr><td>git branch</td><td>" . gitBranch() . "</td></tr>\"\n";
    my $sha1s = `git rev-list --max-count=3 HEAD`;
    chomp($sha1s);
    $sha1s =~ s/\s+/<br>/g;
    print INFOFILE "\"<tr><td>last 3 git commits</td><td>$sha1s</td></tr>\"\n";
} else {
    print INFOFILE "\"<tr><td>can't discover VCS information</td><td></td></tr>\"\n";
}

print INFOFILE "\"</table></body></html>\"\n";
print INFOFILE ";\n";
print INFOFILE "#endif\n";
print INFOFILE "const char BUILDTIME[]=\"$date\";\n";
print INFOFILE "}\n";
close INFOFILE;
